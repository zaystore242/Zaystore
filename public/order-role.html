<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Role - Dalang Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8f9fa; --text-color: #212529; --header-bg: rgba(255, 255, 255, 0.85);
            --card-bg: #ffffff; --border-color: #dee2e6; --primary-color: #0d6efd; 
            --primary-color-rgb: 13, 110, 253; --nav-text-color: #6c757d; 
            --input-bg: #ffffff; --muted-text: #6c757d;
        }
        [data-theme="dark"] {
            --bg-color: #121212; --text-color: #e9ecef; --header-bg: rgba(33, 37, 41, 0.85);
            --card-bg: #1e1e1e; --border-color: #495057; --primary-color: #4dabf7; 
            --primary-color-rgb: 77, 171, 247; --nav-text-color: #adb5bd; 
            --input-bg: #2a2a2e; --muted-text: #adb5bd;
        }
        body {
            font-family: 'Poppins', sans-serif; background-color: var(--bg-color); color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease; padding-top: 70px; padding-bottom: 80px;
        }
        .navbar {
            background-color: var(--header-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color); transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .navbar-brand, h1, h2, h4, h5 { color: var(--text-color) !important; }
        .btn-close { filter: invert(var(--bg-color) == '#121212' ? 1 : 0); }
        .navbar .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
        .btn-outline-secondary {
            color: var(--nav-text-color); border-color: var(--border-color);
        }
        .btn-outline-secondary:hover {
            color: var(--bg-color); background-color: var(--nav-text-color); border-color: var(--nav-text-color);
        }
        .bottom-nav {
            background-color: var(--card-bg); border-top: 1px solid var(--border-color); box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            padding: 0.5rem 0; transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .bottom-nav .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-decoration: none; color: var(--nav-text-color); transition: color 0.2s ease; padding: 5px 0; flex-grow: 1;
        }
        .bottom-nav .nav-item.active { color: var(--primary-color); font-weight: 600; }
        .bottom-nav .nav-item i { font-size: 1.5rem; margin-bottom: 4px; }
        .bottom-nav .nav-item span { font-size: 0.75rem; }
        .card {
            background-color: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-color);
            transition: transform 0.3s ease, background-color 0.3s ease; border-radius: 1rem; height: 100%;
        }
        .card:hover { transform: translateY(-5px); }
        .form-control, .form-select {
            background-color: var(--input-bg); color: var(--text-color); border-color: var(--border-color);
        }
        .form-floating > .form-control:focus, .form-floating > .form-select:focus {
             background-color: var(--input-bg); color: var(--text-color); border-color: var(--primary-color);
             box-shadow: 0 0 0 0.2rem rgba(var(--primary-color-rgb), 0.25);
        }
        .form-floating > label, .text-muted, .lead { color: var(--muted-text) !important; }
        .modal-content, .list-group-item { background-color: var(--card-bg); border-color: var(--border-color); color: var(--text-color); }
        .list-group-item strong, .list-group-item code { color: var(--text-color); }
        code { color: var(--primary-color); }
        .history-item { cursor: pointer; }
        .history-item:hover { background-color: rgba(var(--primary-color-rgb), 0.1); }
    </style>
</head>
<body>

    <header class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html"><i class="bi bi-shop-window me-2"></i>Dalang Store</a>
            <div class="d-flex align-items-center">
                <button id="theme-toggle" class="btn btn-outline-secondary me-2"><i class="bi bi-moon-stars-fill"></i></button>
                <button id="user-history-btn" class="btn btn-outline-secondary me-3"><i class="bi bi-person-circle"></i></button>
                <a href="/login" class="btn btn-primary d-flex align-items-center"><i class="bi bi-box-arrow-in-right me-2"></i><span>Login</span></a>
            </div>
        </div>
    </header>

    <main class="container my-5">
        <div class="text-center mb-5">
            <h1 class="fw-bolder">Pilih Role Anda</h1>
            <p class="lead">Tingkatkan status akun Anda untuk mendapatkan lebih banyak keuntungan.</p>
        </div>
        <div class="row g-4" id="role-selection">
            <div class="col-lg-4 col-md-6">
                <div class="card text-center shadow-sm">
                    <div class="card-body p-4 d-flex flex-column">
                        <i class="bi bi-person-badge fs-1 mb-3" style="color: var(--primary-color);"></i>
                        <h4 class="card-title fw-bold">Reseller</h4>
                        <h2 class="display-5 fw-bolder my-3">Rp 3k</h2>
                        <ul class="list-unstyled text-muted mb-4">
                            <li>Akses ke harga khusus</li><li>Dukungan prioritas</li><li>Cocok untuk pemula</li>
                        </ul>
                        <button class="btn btn-primary mt-auto order-role-btn" data-role="reseller">Pilih Role</button>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <div class="card text-center shadow-sm">
                    <div class="card-body p-4 d-flex flex-column">
                        <i class="bi bi-person-video3 fs-1 mb-3" style="color: var(--primary-color);"></i>
                        <h4 class="card-title fw-bold">Admin</h4>
                        <h2 class="display-5 fw-bolder my-3">Rp 5k</h2>
                        <ul class="list-unstyled text-muted mb-4">
                            <li>Semua keuntungan Reseller</li><li>Akses panel kelola user</li><li>Tingkat lanjut</li>
                        </ul>
                        <button class="btn btn-primary mt-auto order-role-btn" data-role="admin">Pilih Role</button>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-12">
                <div class="card text-center shadow-sm">
                    <div class="card-body p-4 d-flex flex-column">
                        <i class="bi bi-building-gear fs-1 mb-3" style="color: var(--primary-color);"></i>
                        <h4 class="card-title fw-bold">PT</h4>
                        <h2 class="display-5 fw-bolder my-3">Rp 8k</h2>
                        <ul class="list-unstyled text-muted mb-4">
                            <li>Semua keuntungan Admin</li><li>Akses penuh ke sistem</li><li>Level tertinggi</li>
                        </ul>
                        <button class="btn btn-primary mt-auto order-role-btn" data-role="pt">Pilih Role</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <div class="modal fade" id="mainModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-0">
            <h5 class="modal-title" id="modalTitle"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="modalBody"></div>
        </div>
      </div>
    </div>

    <nav class="bottom-nav fixed-bottom d-flex justify-content-around text-center">
        <a href="index.html" class="nav-item"><i class="bi bi-house-fill"></i><span>Beranda</span></a>
        <a href="order-panel.html" class="nav-item"><i class="bi bi-clipboard-check-fill"></i><span>Order Panel</span></a>
        <a href="#" class="nav-item active"><i class="bi bi-person-badge-fill"></i><span>Order Role</span></a>
        <a href="https://wa.me/message/RGDP6NSHA5ZWH1" target="_blank" class="nav-item"><i class="bi bi-whatsapp"></i><span>Dukungan</span></a>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const USER_STORAGE_KEY = 'dalangStoreUserHistory';
            const themeToggle = document.getElementById('theme-toggle');
            const userHistoryBtn = document.getElementById('user-history-btn');
            const body = document.body;
            const themeIcon = themeToggle.querySelector('i');
            const mainModal = new bootstrap.Modal(document.getElementById('mainModal'));
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const roleSelectionContainer = document.getElementById('role-selection');
            let statusInterval;
            let pendingOrder = {};
            
            const applyTheme = (theme) => {
                body.setAttribute('data-theme', theme); localStorage.setItem('theme', theme);
                themeIcon.className = theme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill';
            };
            applyTheme(localStorage.getItem('theme') || 'light');
            themeToggle.addEventListener('click', () => applyTheme(body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));

            const saveUserToHistory = (userData) => {
                const history = getValidUserHistory();
                history.push(userData);
                localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(history));
            };

            const getValidUserHistory = () => JSON.parse(localStorage.getItem(USER_STORAGE_KEY) || '[]');

            const deleteUserFromHistory = (username) => {
                let history = getValidUserHistory();
                history = history.filter(user => user.username !== username);
                localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(history));
                displayUserHistoryModal();
            };

            roleSelectionContainer.addEventListener('click', async (e) => {
                const orderBtn = e.target.closest('.order-role-btn');
                if (!orderBtn) return;
                
                orderBtn.disabled = true; orderBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
                pendingOrder.role = orderBtn.dataset.role;

                try {
                    const response = await fetch(`/api/order/role?role=${pendingOrder.role}`);
                    const result = await response.json();
                    if (result.status) {
                        pendingOrder.deposit_id = result.data.id;
                        displayPaymentModal(result.data);
                    } else { alert(`Error: ${result.msg || 'Terjadi kesalahan'}`); }
                } catch (error) { alert('Gagal menghubungi server.');
                } finally {
                    orderBtn.disabled = false; orderBtn.textContent = 'Pilih Role';
                }
            });

            const displayPaymentModal = (data) => {
                modalTitle.textContent = 'Selesaikan Pembayaran';
                modalBody.innerHTML = `
                    <div class="text-center">
                        <p class="text-muted">Scan QR code di bawah ini untuk membayar.</p>
                        <img src="${data.qr_image}" class="img-fluid mb-3" style="max-width: 250px; border-radius: 10px;" alt="QR Code">
                        <ul class="list-group text-start mb-3">
                            <li class="list-group-item d-flex justify-content-between"><span>Total Bayar</span><strong>Rp ${new Intl.NumberFormat('id-ID').format(data.get_balance)}</strong></li>
                            <li class="list-group-item d-flex justify-content-between"><span>Status</span><strong id="paymentStatusText" class="text-capitalize">${data.status}</strong></li>
                        </ul>
                        <div class="d-grid gap-2 mt-2"><button id="cancelPaymentBtn" class="btn btn-outline-danger">Batalkan Pesanan</button></div>
                    </div>`;
                mainModal.show();
                document.getElementById('cancelPaymentBtn').addEventListener('click', cancelDeposit);
                if (statusInterval) clearInterval(statusInterval);
                statusInterval = setInterval(() => checkPaymentStatus(data.id), 10000);
                checkPaymentStatus(data.id);
            };

            const checkPaymentStatus = async (depositId) => {
                try {
                    const res = await fetch(`/api/deposit/status?id=${depositId}`);
                    const result = await res.json();
                    const statusTextEl = document.getElementById('paymentStatusText');
                    if (statusTextEl) statusTextEl.textContent = result.data.status || 'checking...';
                    if (result.status && result.data.status === 'success') {
                        clearInterval(statusInterval);
                        displayUserCreationForm();
                    } else if (result.status && ['canceled', 'expired'].includes(result.data.status)) {
                        clearInterval(statusInterval);
                        const cancelBtn = document.getElementById('cancelPaymentBtn');
                        if (cancelBtn) cancelBtn.disabled = true;
                    }
                } catch (err) {}
            };

            const cancelDeposit = async () => {
                const cancelBtn = document.getElementById('cancelPaymentBtn');
                cancelBtn.disabled = true; cancelBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Membatalkan...';
                try { await fetch(`/api/deposit/cancel?id=${pendingOrder.deposit_id}`); } catch(error) {}
                clearInterval(statusInterval);
                alert('Pesanan telah dibatalkan.');
                mainModal.hide();
            };

            const displayUserCreationForm = () => {
                modalTitle.textContent = 'Buat Akun Baru';
                modalBody.innerHTML = `
                    <div class="alert alert-success"><i class="bi bi-check-circle-fill me-2"></i>Pembayaran berhasil! Silakan lengkapi data.</div>
                    <form id="createUserForm">
                        <div class="form-floating mb-3"><input type="text" id="username" class="form-control" placeholder="Username" required><label for="username">Username</label></div>
                        <div class="form-floating mb-3"><input type="password" id="password" class="form-control" placeholder="Password" required><label for="password">Password</label></div>
                        <button type="submit" class="btn btn-primary w-100 btn-lg fw-bold">Buat Akun</button>
                    </form>`;
                modalBody.querySelector('#createUserForm').addEventListener('submit', createUser);
            };

            const createUser = async (e) => {
                e.preventDefault();
                const createBtn = e.target.querySelector('button[type="submit"]');
                createBtn.disabled = true; createBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Membuat Akun...';
                pendingOrder.username = document.getElementById('username').value;
                pendingOrder.password = document.getElementById('password').value;
                const params = new URLSearchParams(pendingOrder);
                try {
                    const response = await fetch(`/api/user/add?${params.toString()}`);
                    const result = await response.json();
                    if (result.status) {
                        const fullUserData = { ...result.data, password: pendingOrder.password };
                        saveUserToHistory(fullUserData);
                        displaySuccessDetails(result.data, pendingOrder.password);
                    } else {
                        alert(`Gagal: ${result.msg || 'Terjadi kesalahan'}`);
                        createBtn.disabled = false; createBtn.innerHTML = 'Buat Akun';
                    }
                } catch(error) {
                    alert('Gagal menghubungi server.');
                    createBtn.disabled = false; createBtn.innerHTML = 'Buat Akun';
                }
            };
            
            const displaySuccessDetails = (data, password, fromHistory = false) => {
                modalTitle.textContent = fromHistory ? 'Detail Akun' : 'Akun Berhasil Dibuat';
                modalBody.innerHTML = `
                    <div class="alert alert-success text-center ${fromHistory ? 'd-none' : ''}">
                        <i class="bi bi-person-check-fill fs-1"></i><h4 class="alert-heading mt-2">Sukses!</h4><p class="mb-0">Akun Anda telah siap.</p>
                    </div>
                    <ul class="list-group list-group-flush mt-3">
                        <li class="list-group-item d-flex justify-content-between"><span>Username</span><code>${data.username}</code></li>
                        <li class="list-group-item d-flex justify-content-between"><span>Password</span><code>${password}</code></li>
                        <li class="list-group-item d-flex justify-content-between"><span>Role</span><span class="badge bg-primary text-capitalize p-2">${data.role}</span></li>
                    </ul>
                    <button class="btn btn-secondary w-100 mt-4" data-bs-dismiss="modal">Selesai</button>`;
            };

            const displayUserHistoryModal = () => {
                modalTitle.textContent = 'Riwayat Akun';
                const history = getValidUserHistory();
                if(history.length === 0) {
                    modalBody.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-person-x fs-1"></i><p class="mt-2 mb-0">Tidak ada riwayat akun tersimpan.</p></div>';
                } else {
                    let itemsHTML = history.map(item => `
                        <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center history-item" data-username="${item.username}">
                            <div><strong class="d-block">${item.username}</strong><small class="text-muted text-capitalize">Role: ${item.role}</small></div>
                            <button class="btn btn-sm btn-outline-danger delete-user-btn" data-username="${item.username}"><i class="bi bi-trash"></i></button>
                        </div>
                    `).join('');
                    modalBody.innerHTML = `<div class="list-group">${itemsHTML}</div>`;
                }
                mainModal.show();
            };
            
            userHistoryBtn.addEventListener('click', displayUserHistoryModal);
            
            modalBody.addEventListener('click', (e) => {
                const viewTarget = e.target.closest('.history-item');
                const deleteTarget = e.target.closest('.delete-user-btn');
                if (deleteTarget) {
                    e.stopPropagation();
                    if (confirm('Yakin ingin menghapus riwayat akun ini?')) deleteUserFromHistory(deleteTarget.dataset.username);
                } else if (viewTarget) {
                    const item = getValidUserHistory().find(h => h.username === viewTarget.dataset.username);
                    if (item) displaySuccessDetails(item, item.password, true);
                }
            });

            document.getElementById('mainModal').addEventListener('hidden.bs.modal', () => {
                if (statusInterval) clearInterval(statusInterval);
            });
        });
    </script>
</body>
</html>