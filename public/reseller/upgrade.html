<!DOCTYPE html>
<html lang="id" data-theme="light">
<head>
<meta charset="UTF-8">
<title>Upgrade Peran</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
--theme-bg: #F7F9FC;
--sidebar-bg: #FFFFFF;
--content-bg: #FFFFFF;
--text-primary: #1A202C;
--text-secondary: #718096;
--border-color: #E2E8F0;
--primary-color: #3B82F6;
--primary-color-light: #EFF6FF;
--danger-color: #E53E3E;
--danger-color-light: #FFF5F5;
--success-color: #38A169;
--warning-color: #D69E2E;
--shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
--transition-speed: 0.3s;
}

html[data-theme='dark'] {
--theme-bg: #1A202C;
--sidebar-bg: #2D3748;
--content-bg: #2D3748;
--text-primary: #F7FAFC;
--text-secondary: #A0AEC0;
--border-color: #4A5568;
--primary-color: #4299E1;
--primary-color-light: #2C5282;
--danger-color: #FC8181;
--danger-color-light: rgba(252, 129, 129, 0.1);
--success-color: #68D391;
--warning-color: #F6E05E;
}

body {
    font-family: 'Plus Jakarta Sans', sans-serif;
    background-color: var(--theme-bg);
    color: var(--text-primary);
    transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
}

.wrapper { display: flex; min-height: 100vh; }
.sidebar {
    width: 260px;
    background-color: var(--sidebar-bg);
    border-right: 1px solid var(--border-color);
    padding: 1.5rem 1rem;
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    display: flex;
    flex-direction: column;
    transition: transform var(--transition-speed) ease, background-color var(--transition-speed) ease, border-color var(--transition-speed) ease;
    z-index: 1000;
}

.sidebar-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.25rem;
    font-weight: 800;
    color: var(--text-primary);
    padding: 0 0.5rem 1.5rem 0.5rem;
    margin-bottom: 1rem;
}

.sidebar-body { flex-grow: 1; display: flex; flex-direction: column; }
.sidebar-nav { list-style: none; padding: 0; margin: 0; }
.sidebar-nav a {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    text-decoration: none;
    color: var(--text-secondary);
    font-weight: 600;
    margin-bottom: 0.25rem;
    transition: background-color 0.2s ease, color 0.2s ease;
}
.sidebar-nav a .bi { font-size: 1.2rem; }
.sidebar-nav a:hover { background-color: var(--primary-color-light); color: var(--primary-color); }
.sidebar-nav a.active { background-color: var(--primary-color-light); color: var(--primary-color); }
.sidebar-footer { margin-top: auto; }
.theme-switcher { background-color: var(--theme-bg); padding: 0.5rem; border-radius: 0.5rem; display: flex; align-items: center; justify-content: space-between; }
.theme-switcher .theme-label { font-weight: 600; font-size: 0.9rem; color: var(--text-secondary); margin-left: 0.5rem; }
#theme-toggle { border: none; background: var(--content-bg); color: var(--text-secondary); border-radius: 6px; cursor: pointer; font-size: 1.2rem; padding: 0.4rem 0.5rem; transition: all 0.2s ease; }
#theme-toggle:hover { color: var(--primary-color); }
#theme-toggle .bi-sun-fill { display: none; }
html[data-theme='dark'] #theme-toggle .bi-sun-fill { display: inline-block; }
html[data-theme='dark'] #theme-toggle .bi-moon-fill { display: none; }
.logout-section { padding-top: 1rem; margin-top: 1rem; border-top: 1px solid var(--border-color); }
.logout-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 0.5rem; text-decoration: none; color: var(--text-secondary); font-weight: 600; transition: background-color 0.2s ease, color 0.2s ease; }
.logout-link:hover { background-color: var(--danger-color-light); color: var(--danger-color); }
.logout-link .bi { font-size: 1.2rem; }

.main-content { margin-left: 260px; flex-grow: 1; padding: 2rem; width: calc(100% - 260px); transition: margin-left var(--transition-speed) ease; }
.top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
.page-title-wrapper { display: flex; align-items: center; gap: 1rem; }
#menu-toggle { display: none; background: transparent; border: none; font-size: 1.75rem; color: var(--text-primary); cursor: pointer; }
.page-title { font-size: 2rem; font-weight: 800; margin: 0; color: var(--text-primary); }
.card { background-color: var(--content-bg); border: 1px solid var(--border-color); border-radius: 0.75rem; box-shadow: var(--shadow); transition: background-color var(--transition-speed) ease, border-color var(--transition-speed) ease; }
.form-label { font-weight: 600; color: var(--text-secondary); margin-bottom: 0.5rem; }
.form-select { background-color: var(--theme-bg); border-color: var(--border-color); color: var(--text-primary); font-weight: 500; padding: 0.75rem 1rem; }
.form-select:focus { background-color: var(--theme-bg); color: var(--text-primary); border-color: var(--primary-color); box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.25); }
.btn-primary { font-weight: 700; }

#depositInfo { max-width: 800px; }
.qr-code-img { max-width: 250px; width: 100%; border-radius: 0.75rem; border: 4px solid var(--border-color); }
.deposit-details .label { font-size: 0.9rem; color: var(--text-secondary); font-weight: 600; }
.deposit-details .value { font-size: 1.2rem; font-weight: 700; color: var(--text-primary); }
.status-alert { font-weight: 600; }
.alert-warning { color: var(--warning-color); border-color: var(--warning-color) !important; background-color: rgba(var(--bs-warning-rgb), 0.1); }
.alert-success { color: var(--success-color); border-color: var(--success-color) !important; background-color: rgba(var(--bs-success-rgb), 0.1); }
.alert-danger { color: var(--danger-color); border-color: var(--danger-color) !important; background-color: rgba(var(--bs-danger-rgb), 0.1); }

.overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 999; opacity: 0; visibility: hidden; transition: opacity var(--transition-speed) ease, visibility var(--transition-speed) ease; }
.overlay.active { opacity: 1; visibility: visible; }

@media (max-width: 992px) {
    .sidebar { transform: translateX(-100%); }
    .sidebar.open { transform: translateX(0); box-shadow: 0 0 40px rgba(0,0,0,0.2); }
    .main-content { margin-left: 0; width: 100%; padding: 1.5rem; }
    #menu-toggle { display: block; }
}
</style>
</head>
<body>
<div class="wrapper">
<aside class="sidebar" id="sidebar">
<div class="sidebar-header"><i class="bi bi-shield-check"></i><span>Panel Pengguna</span></div>
<div class="sidebar-body">
<ul class="sidebar-nav">
<li><a href="/reseller"><i class="bi bi-person-fill"></i>Dashboard</a></li>
<li><a href="/create-panel"><i class="bi bi-plus-square-dotted"></i>Buat Panel</a></li>
<li><a href="#" class="active"><i class="bi bi-arrow-up-circle-fill"></i>Upgrade Peran</a></li>
</ul>
<div class="sidebar-footer">
<div class="theme-switcher">
<span class="theme-label">Mode</span>
<button id="theme-toggle" aria-label="Toggle theme"><i class="bi bi-moon-fill"></i><i class="bi bi-sun-fill"></i></button>
</div>
<div class="logout-section"><a href="/logout" class="logout-link"><i class="bi bi-box-arrow-left"></i><span>Logout</span></a></div>
</div>
</div>
</aside>

<div class="overlay" id="overlay"></div>

<main class="main-content">
    <header class="top-header">
        <div class="page-title-wrapper">
            <button id="menu-toggle"><i class="bi bi-list"></i></button>
            <h1 class="page-title">Upgrade Role Pengguna</h1>
        </div>
    </header>
    
    <div id="messageBox"></div>

    <div class="card p-4 p-md-5 mb-4">
        <div class="row align-items-end g-3">
            <div class="col-md">
                <label for="targetRole" class="form-label">Pilih Role Tujuan</label>
                <select class="form-select form-select-lg" id="targetRole">
                    <option value="" selected>Pilih Role...</option>
                    <option value="admin">Admin</option>
                    <option value="pt">PT</option>
                </select>
            </div>
            <div class="col-md-auto">
                <button id="upgradeBtn" class="btn btn-primary btn-lg w-100">
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true" style="display: none;"></span>
                    <i class="bi bi-gem me-1"></i> Buat Deposit & Upgrade
                </button>
            </div>
        </div>
    </div>
    
    <div id="depositInfo" class="card p-4 p-md-5 d-none">
        <div class="row g-4 align-items-center">
            <div class="col-md-8">
                <h4 class="fw-bold mb-4">Informasi Pembayaran</h4>
                <div class="deposit-details d-grid gap-3">
                    <div>
                        <div class="label">ID Deposit</div>
                        <div class="value" id="depositId"></div>
                    </div>
                    <div>
                        <div class="label">Nominal Pembayaran</div>
                        <div class="value text-primary" id="depositNominal"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-center">
                <p class="fw-bold mb-2">Pindai QR untuk Membayar</p>
                <img id="depositQR" src="" alt="QR Payment" class="qr-code-img"/>
            </div>
            <div class="col-12 mt-4">
                <div id="statusAlert" class="alert status-alert" role="alert"></div>
            </div>
            <div class="col-12 mt-3 text-center">
                <button id="cancelBtn" class="btn btn-outline-danger">
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true" style="display: none;"></span>
                    <i class="bi bi-x-circle me-1"></i> Batalkan Deposit
                </button>
            </div>
        </div>
    </div>
</main>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("overlay");
        const menuToggle = document.getElementById("menu-toggle");
        const themeToggle = document.getElementById('theme-toggle');
        const htmlEl = document.documentElement;

        const toggleSidebar = () => { sidebar.classList.toggle("open"); overlay.classList.toggle("active"); };
        menuToggle.addEventListener("click", toggleSidebar);
        overlay.addEventListener("click", toggleSidebar);

        const applyTheme = (theme) => { htmlEl.setAttribute('data-theme', theme); localStorage.setItem('theme', theme); };
        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);
        themeToggle.addEventListener('click', () => applyTheme(htmlEl.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));

        const upgradeBtn = document.getElementById("upgradeBtn");
        const cancelBtn = document.getElementById("cancelBtn");
        const depositInfo = document.getElementById("depositInfo");
        const depositIdEl = document.getElementById("depositId");
        const depositNominalEl = document.getElementById("depositNominal");
        const depositQR = document.getElementById("depositQR");
        const statusAlert = document.getElementById("statusAlert");
        const messageBox = document.getElementById("messageBox");
        let intervalCheck = null;
        let currentDepositId = null;

        const setButtonLoadingState = (button, isLoading) => {
            const spinner = button.querySelector('.spinner-border');
            const icon = button.querySelector('.bi');
            button.disabled = isLoading;
            if (spinner) spinner.style.display = isLoading ? 'inline-block' : 'none';
            if (icon) icon.style.display = isLoading ? 'none' : 'inline-block';
        };
        
        const showAlert = (message, type = 'danger') => {
            messageBox.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
        };

        const updateStatusAlert = (className, icon, text) => {
            statusAlert.className = `alert ${className} status-alert d-flex align-items-center`;
            statusAlert.innerHTML = `<i class="bi ${icon} fs-4 me-3"></i> <div>${text}</div>`;
        };
        
        const startStatusCheck = (depositId) => {
            if (intervalCheck) clearInterval(intervalCheck);

            intervalCheck = setInterval(async () => {
                try {
                    const response = await fetch("/reseller/status", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ id: depositId })
                    });
                    
                    if (!response.ok) return;
                    
                    const result = await response.json();
                    const status = result.data.status.toLowerCase();

                    if (status === "processing" || status === "success") {
                        updateStatusAlert('alert-success', 'bi-check-circle-fill', `Deposit Berhasil! Peran Anda telah diupgrade. Anda akan logout dalam 3 detik.`);
                        clearInterval(intervalCheck);
                        cancelBtn.disabled = true;
                        setTimeout(() => {
                            window.location.href = '/logout';
                        }, 3000);
                    } else if (status === "failed") {
                        updateStatusAlert('alert-danger', 'bi-x-circle-fill', 'Pembayaran Gagal. Peran tidak berubah.');
                        clearInterval(intervalCheck);
                    } else if (status === "cancel") {
                         updateStatusAlert('alert-danger', 'bi-x-circle-fill', 'Deposit telah dibatalkan.');
                         clearInterval(intervalCheck);
                    }
                } catch (err) {
                    console.error("Gagal memeriksa status deposit:", err);
                }
            }, 5000);
        };

        upgradeBtn.addEventListener("click", async () => {
            const targetRole = document.getElementById("targetRole").value;
            if (!targetRole) {
                showAlert("Harap pilih peran tujuan terlebih dahulu.", "warning");
                return;
            }

            setButtonLoadingState(upgradeBtn, true);
            messageBox.innerHTML = "";

            try {
                const response = await fetch("/reseller/upgrade", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ targetRole })
                });
                
                const data = await response.json();
                
                if (!response.ok || data.error) {
                    throw new Error(data.error || "Gagal membuat permintaan upgrade.");
                }

                const deposit = data.deposit;
                currentDepositId = deposit.id;
                depositIdEl.textContent = deposit.id;
                depositNominalEl.textContent = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(deposit.nominal);
                depositQR.src = deposit.qr_image;
                updateStatusAlert('alert-warning', 'bi-hourglass-split', 'Menunggu Pembayaran. Peran Anda belum diubah.');
                depositInfo.classList.remove("d-none");
                cancelBtn.disabled = false;

                startStatusCheck(deposit.id);

            } catch (err) {
                showAlert(err.message || "Terjadi kesalahan saat membuat deposit.");
            } finally {
                setButtonLoadingState(upgradeBtn, false);
            }
        });

        cancelBtn.addEventListener("click", async () => {
            if (!currentDepositId) return;

            setButtonLoadingState(cancelBtn, true);

            try {
                const response = await fetch(`/reseller/deposit/cancel?id=${currentDepositId}`);
                const result = await response.json();

                if (!response.ok || !result.status) {
                    throw new Error(result.message || "Gagal membatalkan deposit.");
                }
                
                clearInterval(intervalCheck);
                depositInfo.classList.add("d-none");
                showAlert("Deposit berhasil dibatalkan.", "success");
                currentDepositId = null;

            } catch (err) {
                showAlert(err.message || "Terjadi kesalahan saat membatalkan.", "danger");
            } finally {
                setButtonLoadingState(cancelBtn, false);
            }
        });
    });
</script>
</body>
</html>